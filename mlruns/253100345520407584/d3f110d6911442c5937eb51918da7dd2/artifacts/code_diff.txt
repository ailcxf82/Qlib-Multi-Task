diff --git a/project/README.md b/project/README.md
index 46f752b..a4092a0 100644
--- a/project/README.md
+++ b/project/README.md
@@ -25,7 +25,8 @@ project/
 - **模型体系**：
   - `LightGBMModelWrapper` 封装 qlib 原生 LightGBM，输出预测值与叶子索引；
   - `MLPRegressor` 由 PyTorch 实现的一层或多层感知机；
-  - `LeafStackModel` 接收 LGB 叶子 one-hot 编码，用 MLP 学习 residual 并与原 LGB 预测融合。
+  - `LeafStackModel` 支持 OneHot 或哈希压缩方式处理 LGB 叶子索引，用 MLP 学习 residual 并与原 LGB 预测融合，避免稀疏矩阵爆内存。
+- **多模型协同**：`EnsembleModelManager` 基于 qlib `AverageEnsemble` 统一训练/推理 LGB、MLP 等模型，可通过 `pipeline.yaml -> ensemble` 增减模型并获取融合预测。
 - **IC 动态加权**：`RankICDynamicWeighter` 基于 rank-IC 半衰期均值与波动计算权重，支持 min/max/负值裁剪。
 - **组合构建**：`PortfolioBuilder` 设定最大仓位、单股权重与行业敞口，生成最终权重。
 - **滚动训练**：`RollingTrainer` 按 `pipeline.yaml` 的窗口设置执行训练、评估、模型保存以及训练日志记录。
@@ -56,8 +57,8 @@ project/
 - `config/data.yaml`：数据提供者地址、交易品种、时间区间、因子列表、标签与标准化方式。
 - `config/model_lgb.yaml`：LightGBM 超参（叶子数、学习率、bagging 等）。
 - `config/model_mlp.yaml`：MLP 网络结构、训练批量、学习率等。
-- `config/model_stack.yaml`：Stack MLP 结构及 `alpha`（融合权重）。
-- `config/pipeline.yaml`：滚动窗口长度、IC 动态加权窗口、模型/日志/预测/回测路径，以及组合约束参数。
+- `config/model_stack.yaml`：Stack MLP 结构、`alpha`（融合权重）、`encoding/hash_dim` 等叶子编码策略。
+- `config/pipeline.yaml`：滚动窗口长度、IC 动态加权窗口、模型/日志/预测/回测路径，以及组合约束参数；新增 `ensemble` 区块用于声明多模型名单、配置引用与 qlib 融合策略。
 
 ## 5. 扩展建议
 
diff --git a/project/config/model_stack.yaml b/project/config/model_stack.yaml
index f4f5317..e94b10a 100644
--- a/project/config/model_stack.yaml
+++ b/project/config/model_stack.yaml
@@ -1,5 +1,7 @@
 stack:
   alpha: 0.5
+  encoding: "hashing"   # 可选 onehot/hash- based，默认哈希压缩
+  hash_dim: 1024
   hidden_dims: [256, 128]
   dropout: 0.1
   activation: "relu"
diff --git a/project/config/pipeline.yaml b/project/config/pipeline.yaml
index 5228c6a..9ab78dc 100644
--- a/project/config/pipeline.yaml
+++ b/project/config/pipeline.yaml
@@ -3,6 +3,16 @@ lightgbm_config: "config/model_lgb.yaml"
 mlp_config: "config/model_mlp.yaml"
 stack_config: "config/model_stack.yaml"
 
+ensemble:
+  aggregator: "average"
+  models:
+    - name: "lgb"
+      type: "lightgbm"
+      config_key: "lightgbm_config"
+    - name: "mlp"
+      type: "mlp"
+      config_key: "mlp_config"
+
 rolling:
   train_months: 24
   valid_months: 1
diff --git a/project/data/models/20180131_mlp.pt b/project/data/models/20180131_mlp.pt
index c2515be..846c09e 100644
Binary files a/project/data/models/20180131_mlp.pt and b/project/data/models/20180131_mlp.pt differ
diff --git a/project/data/models/20180131_stack_mlp.pt b/project/data/models/20180131_stack_mlp.pt
index ca6832b..60f6e9e 100644
Binary files a/project/data/models/20180131_stack_mlp.pt and b/project/data/models/20180131_stack_mlp.pt differ
diff --git a/project/data/models/20180228_mlp.pt b/project/data/models/20180228_mlp.pt
index 82b963a..67aa68d 100644
Binary files a/project/data/models/20180228_mlp.pt and b/project/data/models/20180228_mlp.pt differ
diff --git a/project/data/models/20180228_stack_mlp.pt b/project/data/models/20180228_stack_mlp.pt
index 3849a71..278d717 100644
Binary files a/project/data/models/20180228_stack_mlp.pt and b/project/data/models/20180228_stack_mlp.pt differ
diff --git a/project/data/models/20180331_mlp.pt b/project/data/models/20180331_mlp.pt
index 01b6dbd..aa4cd08 100644
Binary files a/project/data/models/20180331_mlp.pt and b/project/data/models/20180331_mlp.pt differ
diff --git a/project/data/models/20180331_stack_mlp.pt b/project/data/models/20180331_stack_mlp.pt
index 5ee1b1c..f67bee0 100644
Binary files a/project/data/models/20180331_stack_mlp.pt and b/project/data/models/20180331_stack_mlp.pt differ
diff --git a/project/data/models/20180430_mlp.pt b/project/data/models/20180430_mlp.pt
index e537011..e94866f 100644
Binary files a/project/data/models/20180430_mlp.pt and b/project/data/models/20180430_mlp.pt differ
diff --git a/project/data/models/20180430_stack_mlp.pt b/project/data/models/20180430_stack_mlp.pt
index 245cfb6..52735f4 100644
Binary files a/project/data/models/20180430_stack_mlp.pt and b/project/data/models/20180430_stack_mlp.pt differ
diff --git a/project/data/models/20180531_mlp.pt b/project/data/models/20180531_mlp.pt
index fdf2e04..cc08a78 100644
Binary files a/project/data/models/20180531_mlp.pt and b/project/data/models/20180531_mlp.pt differ
diff --git a/project/data/models/20180531_stack_mlp.pt b/project/data/models/20180531_stack_mlp.pt
index 813bb69..eca7f5e 100644
Binary files a/project/data/models/20180531_stack_mlp.pt and b/project/data/models/20180531_stack_mlp.pt differ
diff --git a/project/data/models/20180630_mlp.pt b/project/data/models/20180630_mlp.pt
index 4d5d3ae..077fc00 100644
Binary files a/project/data/models/20180630_mlp.pt and b/project/data/models/20180630_mlp.pt differ
diff --git a/project/data/models/20180630_stack_mlp.pt b/project/data/models/20180630_stack_mlp.pt
index f6e1836..bd436bd 100644
Binary files a/project/data/models/20180630_stack_mlp.pt and b/project/data/models/20180630_stack_mlp.pt differ
diff --git a/project/data/models/20180731_mlp.pt b/project/data/models/20180731_mlp.pt
index 9a15972..dbb1389 100644
Binary files a/project/data/models/20180731_mlp.pt and b/project/data/models/20180731_mlp.pt differ
diff --git a/project/data/models/20180731_stack_mlp.pt b/project/data/models/20180731_stack_mlp.pt
index 8728d75..7087165 100644
Binary files a/project/data/models/20180731_stack_mlp.pt and b/project/data/models/20180731_stack_mlp.pt differ
diff --git a/project/data/models/20180831_mlp.pt b/project/data/models/20180831_mlp.pt
index d0bb7fb..90ca7c6 100644
Binary files a/project/data/models/20180831_mlp.pt and b/project/data/models/20180831_mlp.pt differ
diff --git a/project/data/models/20180831_stack_mlp.pt b/project/data/models/20180831_stack_mlp.pt
index fbeee58..b975e2c 100644
Binary files a/project/data/models/20180831_stack_mlp.pt and b/project/data/models/20180831_stack_mlp.pt differ
diff --git a/project/data/models/20180930_mlp.pt b/project/data/models/20180930_mlp.pt
index c39ab3b..875e5ea 100644
Binary files a/project/data/models/20180930_mlp.pt and b/project/data/models/20180930_mlp.pt differ
diff --git a/project/data/models/20180930_stack_mlp.pt b/project/data/models/20180930_stack_mlp.pt
index c792ad5..a487e8e 100644
Binary files a/project/data/models/20180930_stack_mlp.pt and b/project/data/models/20180930_stack_mlp.pt differ
diff --git a/project/data/models/20181031_mlp.pt b/project/data/models/20181031_mlp.pt
index fd5beb4..3821052 100644
Binary files a/project/data/models/20181031_mlp.pt and b/project/data/models/20181031_mlp.pt differ
diff --git a/project/data/models/20181031_stack_mlp.pt b/project/data/models/20181031_stack_mlp.pt
index 5359e3f..2b6f0ce 100644
Binary files a/project/data/models/20181031_stack_mlp.pt and b/project/data/models/20181031_stack_mlp.pt differ
diff --git a/project/data/models/20181130_mlp.pt b/project/data/models/20181130_mlp.pt
index f8e634b..9d8ac76 100644
Binary files a/project/data/models/20181130_mlp.pt and b/project/data/models/20181130_mlp.pt differ
diff --git a/project/data/models/20181130_stack_mlp.pt b/project/data/models/20181130_stack_mlp.pt
index cee64bb..a942e77 100644
Binary files a/project/data/models/20181130_stack_mlp.pt and b/project/data/models/20181130_stack_mlp.pt differ
diff --git a/project/data/models/20181231_mlp.pt b/project/data/models/20181231_mlp.pt
index 188f82d..f76b4b8 100644
Binary files a/project/data/models/20181231_mlp.pt and b/project/data/models/20181231_mlp.pt differ
diff --git a/project/data/models/20181231_stack_mlp.pt b/project/data/models/20181231_stack_mlp.pt
index 615f5bb..e3f3f82 100644
Binary files a/project/data/models/20181231_stack_mlp.pt and b/project/data/models/20181231_stack_mlp.pt differ
diff --git a/project/data/models/20190131_mlp.pt b/project/data/models/20190131_mlp.pt
index 0472a50..6954170 100644
Binary files a/project/data/models/20190131_mlp.pt and b/project/data/models/20190131_mlp.pt differ
diff --git a/project/data/models/20190131_stack_mlp.pt b/project/data/models/20190131_stack_mlp.pt
index 114b13c..4b9efcf 100644
Binary files a/project/data/models/20190131_stack_mlp.pt and b/project/data/models/20190131_stack_mlp.pt differ
diff --git a/project/data/models/20190228_mlp.pt b/project/data/models/20190228_mlp.pt
index dab4ca0..3fe6dc7 100644
Binary files a/project/data/models/20190228_mlp.pt and b/project/data/models/20190228_mlp.pt differ
diff --git a/project/data/models/20190228_stack_mlp.pt b/project/data/models/20190228_stack_mlp.pt
index 9555ad4..82a0484 100644
Binary files a/project/data/models/20190228_stack_mlp.pt and b/project/data/models/20190228_stack_mlp.pt differ
diff --git a/project/data/models/20190331_mlp.pt b/project/data/models/20190331_mlp.pt
index 5d88826..91e48d9 100644
Binary files a/project/data/models/20190331_mlp.pt and b/project/data/models/20190331_mlp.pt differ
diff --git a/project/data/models/20190331_stack_mlp.pt b/project/data/models/20190331_stack_mlp.pt
index eaacbf2..d25c6f1 100644
Binary files a/project/data/models/20190331_stack_mlp.pt and b/project/data/models/20190331_stack_mlp.pt differ
diff --git a/project/data/models/20190430_mlp.pt b/project/data/models/20190430_mlp.pt
index 41726a5..a48e8c6 100644
Binary files a/project/data/models/20190430_mlp.pt and b/project/data/models/20190430_mlp.pt differ
diff --git a/project/data/models/20190430_stack_mlp.pt b/project/data/models/20190430_stack_mlp.pt
index a6a26e7..9594b71 100644
Binary files a/project/data/models/20190430_stack_mlp.pt and b/project/data/models/20190430_stack_mlp.pt differ
diff --git a/project/data/models/20190531_mlp.pt b/project/data/models/20190531_mlp.pt
index 3f0e3a4..daf30da 100644
Binary files a/project/data/models/20190531_mlp.pt and b/project/data/models/20190531_mlp.pt differ
diff --git a/project/data/models/20190531_stack_mlp.pt b/project/data/models/20190531_stack_mlp.pt
index a2f8b1b..a63fbd2 100644
Binary files a/project/data/models/20190531_stack_mlp.pt and b/project/data/models/20190531_stack_mlp.pt differ
diff --git a/project/data/models/20190630_mlp.pt b/project/data/models/20190630_mlp.pt
index 7165937..65c9d55 100644
Binary files a/project/data/models/20190630_mlp.pt and b/project/data/models/20190630_mlp.pt differ
diff --git a/project/data/models/20190630_stack_mlp.pt b/project/data/models/20190630_stack_mlp.pt
index 461c466..e8a37a2 100644
Binary files a/project/data/models/20190630_stack_mlp.pt and b/project/data/models/20190630_stack_mlp.pt differ
diff --git a/project/data/models/20190731_mlp.pt b/project/data/models/20190731_mlp.pt
index 627f7d4..f0453ec 100644
Binary files a/project/data/models/20190731_mlp.pt and b/project/data/models/20190731_mlp.pt differ
diff --git a/project/data/models/20190731_stack_mlp.pt b/project/data/models/20190731_stack_mlp.pt
index 6b51da9..f51d8b8 100644
Binary files a/project/data/models/20190731_stack_mlp.pt and b/project/data/models/20190731_stack_mlp.pt differ
diff --git a/project/data/models/20190831_mlp.pt b/project/data/models/20190831_mlp.pt
index 711c520..e310784 100644
Binary files a/project/data/models/20190831_mlp.pt and b/project/data/models/20190831_mlp.pt differ
diff --git a/project/data/models/20190831_stack_mlp.pt b/project/data/models/20190831_stack_mlp.pt
index 979441f..3faec6a 100644
Binary files a/project/data/models/20190831_stack_mlp.pt and b/project/data/models/20190831_stack_mlp.pt differ
diff --git a/project/data/models/20190930_mlp.pt b/project/data/models/20190930_mlp.pt
index dfa1cbc..fdb9c7b 100644
Binary files a/project/data/models/20190930_mlp.pt and b/project/data/models/20190930_mlp.pt differ
diff --git a/project/data/models/20190930_stack_mlp.pt b/project/data/models/20190930_stack_mlp.pt
index f1b31d6..9a57797 100644
Binary files a/project/data/models/20190930_stack_mlp.pt and b/project/data/models/20190930_stack_mlp.pt differ
diff --git a/project/data/models/20191031_mlp.pt b/project/data/models/20191031_mlp.pt
index cb06411..788440f 100644
Binary files a/project/data/models/20191031_mlp.pt and b/project/data/models/20191031_mlp.pt differ
diff --git a/project/data/models/20191031_stack_mlp.pt b/project/data/models/20191031_stack_mlp.pt
index d528cb8..c1ef775 100644
Binary files a/project/data/models/20191031_stack_mlp.pt and b/project/data/models/20191031_stack_mlp.pt differ
diff --git a/project/data/models/20191130_mlp.pt b/project/data/models/20191130_mlp.pt
index 7aab0d3..2bbfdfc 100644
Binary files a/project/data/models/20191130_mlp.pt and b/project/data/models/20191130_mlp.pt differ
diff --git a/project/data/models/20191130_stack_mlp.pt b/project/data/models/20191130_stack_mlp.pt
index e9e3368..cea4035 100644
Binary files a/project/data/models/20191130_stack_mlp.pt and b/project/data/models/20191130_stack_mlp.pt differ
diff --git a/project/data/models/20191231_mlp.pt b/project/data/models/20191231_mlp.pt
index 824aef7..991a243 100644
Binary files a/project/data/models/20191231_mlp.pt and b/project/data/models/20191231_mlp.pt differ
diff --git a/project/data/models/20191231_stack_mlp.pt b/project/data/models/20191231_stack_mlp.pt
index 8e74e18..b8ee154 100644
Binary files a/project/data/models/20191231_stack_mlp.pt and b/project/data/models/20191231_stack_mlp.pt differ
diff --git a/project/data/models/20200131_mlp.pt b/project/data/models/20200131_mlp.pt
index 6bb16db..7d5018e 100644
Binary files a/project/data/models/20200131_mlp.pt and b/project/data/models/20200131_mlp.pt differ
diff --git a/project/data/models/20200131_stack_mlp.pt b/project/data/models/20200131_stack_mlp.pt
index 965c3b8..897dded 100644
Binary files a/project/data/models/20200131_stack_mlp.pt and b/project/data/models/20200131_stack_mlp.pt differ
diff --git a/project/data/models/20200229_mlp.pt b/project/data/models/20200229_mlp.pt
index ffefef8..1925034 100644
Binary files a/project/data/models/20200229_mlp.pt and b/project/data/models/20200229_mlp.pt differ
diff --git a/project/data/models/20200229_stack_mlp.pt b/project/data/models/20200229_stack_mlp.pt
index 129dbbc..fe3fe6e 100644
Binary files a/project/data/models/20200229_stack_mlp.pt and b/project/data/models/20200229_stack_mlp.pt differ
diff --git a/project/data/models/20200331_mlp.pt b/project/data/models/20200331_mlp.pt
index 700b709..75afe6e 100644
Binary files a/project/data/models/20200331_mlp.pt and b/project/data/models/20200331_mlp.pt differ
diff --git a/project/data/models/20200331_stack_mlp.pt b/project/data/models/20200331_stack_mlp.pt
index 7a9987b..a440794 100644
Binary files a/project/data/models/20200331_stack_mlp.pt and b/project/data/models/20200331_stack_mlp.pt differ
diff --git a/project/data/models/20200430_mlp.pt b/project/data/models/20200430_mlp.pt
index f7b56b7..7f937cf 100644
Binary files a/project/data/models/20200430_mlp.pt and b/project/data/models/20200430_mlp.pt differ
diff --git a/project/data/models/20200430_stack_mlp.pt b/project/data/models/20200430_stack_mlp.pt
index f007558..5713098 100644
Binary files a/project/data/models/20200430_stack_mlp.pt and b/project/data/models/20200430_stack_mlp.pt differ
diff --git a/project/data/models/20200531_mlp.pt b/project/data/models/20200531_mlp.pt
index 26e6994..7f16a81 100644
Binary files a/project/data/models/20200531_mlp.pt and b/project/data/models/20200531_mlp.pt differ
diff --git a/project/data/models/20200531_stack_mlp.pt b/project/data/models/20200531_stack_mlp.pt
index 295e052..14b94d7 100644
Binary files a/project/data/models/20200531_stack_mlp.pt and b/project/data/models/20200531_stack_mlp.pt differ
diff --git a/project/data/models/20200630_mlp.pt b/project/data/models/20200630_mlp.pt
index 3fa40b5..685ab73 100644
Binary files a/project/data/models/20200630_mlp.pt and b/project/data/models/20200630_mlp.pt differ
diff --git a/project/data/models/20200630_stack_mlp.pt b/project/data/models/20200630_stack_mlp.pt
index 286abaf..ff54780 100644
Binary files a/project/data/models/20200630_stack_mlp.pt and b/project/data/models/20200630_stack_mlp.pt differ
diff --git a/project/data/models/20200731_mlp.pt b/project/data/models/20200731_mlp.pt
index 5a0a493..10ad755 100644
Binary files a/project/data/models/20200731_mlp.pt and b/project/data/models/20200731_mlp.pt differ
diff --git a/project/data/models/20200731_stack_mlp.pt b/project/data/models/20200731_stack_mlp.pt
index 89c3ea0..bbb255b 100644
Binary files a/project/data/models/20200731_stack_mlp.pt and b/project/data/models/20200731_stack_mlp.pt differ
diff --git a/project/data/models/20200831_mlp.pt b/project/data/models/20200831_mlp.pt
index 5964993..ab733e4 100644
Binary files a/project/data/models/20200831_mlp.pt and b/project/data/models/20200831_mlp.pt differ
diff --git a/project/data/models/20200831_stack_mlp.pt b/project/data/models/20200831_stack_mlp.pt
index d8c058d..b033af9 100644
Binary files a/project/data/models/20200831_stack_mlp.pt and b/project/data/models/20200831_stack_mlp.pt differ
diff --git a/project/data/models/20200930_mlp.pt b/project/data/models/20200930_mlp.pt
index 99c07aa..690ab42 100644
Binary files a/project/data/models/20200930_mlp.pt and b/project/data/models/20200930_mlp.pt differ
diff --git a/project/data/models/20200930_stack_mlp.pt b/project/data/models/20200930_stack_mlp.pt
index 9cb23b7..5e2c92e 100644
Binary files a/project/data/models/20200930_stack_mlp.pt and b/project/data/models/20200930_stack_mlp.pt differ
diff --git a/project/feature/__pycache__/qlib_feature_pipeline.cpython-311.pyc b/project/feature/__pycache__/qlib_feature_pipeline.cpython-311.pyc
index d64ecc8..35e8ce0 100644
Binary files a/project/feature/__pycache__/qlib_feature_pipeline.cpython-311.pyc and b/project/feature/__pycache__/qlib_feature_pipeline.cpython-311.pyc differ
diff --git a/project/feature/qlib_feature_pipeline.py b/project/feature/qlib_feature_pipeline.py
index c1b297f..767faf4 100644
--- a/project/feature/qlib_feature_pipeline.py
+++ b/project/feature/qlib_feature_pipeline.py
@@ -18,6 +18,7 @@ from qlib.data import D
 from utils import load_yaml_config
 
 logger = logging.getLogger(__name__)
+_QLIB_INITIALIZED = False
 
 
 class QlibFeaturePipeline:
@@ -34,7 +35,16 @@ class QlibFeaturePipeline:
 
     def _init_qlib(self):
         qlib_cfg = self.config.get("qlib", {})
-        if qlib.is_initialized():
+        global _QLIB_INITIALIZED
+        already_initialized = False
+        if hasattr(qlib, "is_initialized"):
+            try:
+                already_initialized = bool(qlib.is_initialized())
+            except Exception:
+                already_initialized = _QLIB_INITIALIZED
+        else:
+            already_initialized = _QLIB_INITIALIZED
+        if already_initialized:
             # 在 notebook/调试环境中可能重复调用，避免重复初始化
             return
         logger.info("初始化 qlib，数据目录: %s", qlib_cfg.get("provider_uri"))
@@ -43,6 +53,7 @@ class QlibFeaturePipeline:
             region=qlib_cfg.get("region", "cn"),
             expression_cache=None,
         )
+        _QLIB_INITIALIZED = True
 
     def build(self):
         """执行特征提取。"""
diff --git a/project/models/__pycache__/lightgbm_model.cpython-311.pyc b/project/models/__pycache__/lightgbm_model.cpython-311.pyc
index c0d30e3..bbb608c 100644
Binary files a/project/models/__pycache__/lightgbm_model.cpython-311.pyc and b/project/models/__pycache__/lightgbm_model.cpython-311.pyc differ
diff --git a/project/models/__pycache__/mlp_model.cpython-311.pyc b/project/models/__pycache__/mlp_model.cpython-311.pyc
index fa4855c..2b7135d 100644
Binary files a/project/models/__pycache__/mlp_model.cpython-311.pyc and b/project/models/__pycache__/mlp_model.cpython-311.pyc differ
diff --git a/project/models/__pycache__/stack_model.cpython-311.pyc b/project/models/__pycache__/stack_model.cpython-311.pyc
index e624162..b7c5b6b 100644
Binary files a/project/models/__pycache__/stack_model.cpython-311.pyc and b/project/models/__pycache__/stack_model.cpython-311.pyc differ
diff --git a/project/models/stack_model.py b/project/models/stack_model.py
index 9d8e435..8ebba84 100644
--- a/project/models/stack_model.py
+++ b/project/models/stack_model.py
@@ -11,6 +11,7 @@ from typing import Optional
 
 import numpy as np
 import pandas as pd
+from sklearn.feature_extraction import FeatureHasher
 from sklearn.preprocessing import OneHotEncoder
 
 from models.mlp_model import MLPRegressor
@@ -20,22 +21,43 @@ logger = logging.getLogger(__name__)
 
 
 class LeafStackModel:
-    """叶子编码 + MLP 的二级模型。"""
+    """叶子编码 + MLP 的二级模型，支持 OneHot 或哈希压缩编码。"""
 
     def __init__(self, config_path: str):
         cfg = load_yaml_config(config_path)
         self.config = cfg.get("stack", cfg)
         self.alpha = self.config.get("alpha", 0.5)
-        # 叶子编号是稀疏离散变量，采用 OneHotEncoder 映射为稠密特征
-        self.encoder = OneHotEncoder(handle_unknown="ignore", sparse_output=False, dtype=np.float32)
+        self.encoding = self.config.get("encoding", "hashing").lower()
+        self.hash_dim = self.config.get("hash_dim", 1024)
+        self.encoder: Optional[OneHotEncoder] = None
+        self.hasher: Optional[FeatureHasher] = None
+        if self.encoding == "onehot":
+            self.encoder = OneHotEncoder(handle_unknown="ignore", sparse_output=False, dtype=np.float32)
+        elif self.encoding == "hashing":
+            self.hasher = FeatureHasher(
+                n_features=self.hash_dim,
+                input_type="dict",
+                dtype=np.float32,
+            )
+        else:
+            raise ValueError(f"不支持的叶子编码方式: {self.encoding}")
+        exclude_keys = {"alpha", "encoding", "hash_dim"}
         self.feature_names: Optional[list[str]] = None
-        self.mlp = MLPRegressor({"model": {k: v for k, v in self.config.items() if k != "alpha"}})
+        self.mlp = MLPRegressor({"model": {k: v for k, v in self.config.items() if k not in exclude_keys}})
 
-    def _to_frame(self, encoded: np.ndarray, index: pd.Index) -> pd.DataFrame:
+    def _to_frame(self, encoded: np.ndarray, index: pd.Index, prefix: str = "leaf") -> pd.DataFrame:
         if self.feature_names is None or len(self.feature_names) != encoded.shape[1]:
-            self.feature_names = [f"leaf_{i}" for i in range(encoded.shape[1])]
+            self.feature_names = [f"{prefix}_{i}" for i in range(encoded.shape[1])]
         return pd.DataFrame(encoded, index=index, columns=self.feature_names)
 
+    def _hash_leaf(self, leaf: np.ndarray, index: pd.Index) -> pd.DataFrame:
+        if self.hasher is None:
+            raise RuntimeError("哈希编码器未初始化")
+        rows = ({f"t{j}_{leaf_val}": 1 for j, leaf_val in enumerate(sample)} for sample in leaf)
+        encoded_sparse = self.hasher.transform(rows)
+        encoded = encoded_sparse.toarray()
+        return self._to_frame(encoded, index, prefix="hash")
+
     def fit(
         self,
         train_leaf: np.ndarray,
@@ -43,9 +65,14 @@ class LeafStackModel:
         valid_leaf: Optional[np.ndarray] = None,
         valid_residual: Optional[pd.Series] = None,
     ):
-        logger.info("训练 Stack 模型，样本: %d，特征维度: %d", train_leaf.shape[0], train_leaf.shape[1])
-        train_encoded = self.encoder.fit_transform(train_leaf)
-        train_df = self._to_frame(train_encoded, train_residual.index)
+        logger.info("训练 Stack 模型，样本: %d，原始叶子维度: %d", train_leaf.shape[0], train_leaf.shape[1])
+        if self.encoding == "onehot":
+            if self.encoder is None:
+                raise RuntimeError("OneHotEncoder 未初始化")
+            train_encoded = self.encoder.fit_transform(train_leaf)
+            train_df = self._to_frame(train_encoded, train_residual.index, prefix="leaf")
+        else:
+            train_df = self._hash_leaf(train_leaf, train_residual.index)
         valid_df = None
         if (
             valid_leaf is not None
@@ -53,14 +80,22 @@ class LeafStackModel:
             and len(valid_leaf) > 0
             and len(valid_residual) > 0
         ):
-            valid_encoded = self.encoder.transform(valid_leaf)
-            valid_df = self._to_frame(valid_encoded, valid_residual.index)
+            if self.encoding == "onehot":
+                valid_encoded = self.encoder.transform(valid_leaf)
+                valid_df = self._to_frame(valid_encoded, valid_residual.index, prefix="leaf")
+            else:
+                valid_df = self._hash_leaf(valid_leaf, valid_residual.index)
         self.mlp.fit(train_df, train_residual, valid_df, valid_residual)
 
     def predict_residual(self, leaf: np.ndarray, index: pd.Index) -> pd.Series:
         # 线上阶段只需 transform（不再 fit）
-        encoded = self.encoder.transform(leaf)
-        feat_df = self._to_frame(encoded, index)
+        if self.encoding == "onehot":
+            if self.encoder is None:
+                raise RuntimeError("OneHotEncoder 未初始化")
+            encoded = self.encoder.transform(leaf)
+            feat_df = self._to_frame(encoded, index, prefix="leaf")
+        else:
+            feat_df = self._hash_leaf(leaf, index)
         return self.mlp.predict(feat_df)
 
     def fuse(self, lgb_pred: pd.Series, residual_pred: pd.Series) -> pd.Series:
@@ -71,16 +106,15 @@ class LeafStackModel:
         os.makedirs(output_dir, exist_ok=True)
         enc_path = os.path.join(output_dir, f"{model_name}_stack_encoder.json")
         with open(enc_path, "w", encoding="utf-8") as fp:
-            json.dump(
-                {
-                    "categories": [cat.tolist() for cat in self.encoder.categories_],
-                    "feature_names": self.feature_names,
-                    "alpha": self.alpha,
-                },
-                fp,
-                ensure_ascii=False,
-                indent=2,
-            )
+            meta = {
+                "feature_names": self.feature_names,
+                "alpha": self.alpha,
+                "encoding": self.encoding,
+                "hash_dim": self.hash_dim,
+            }
+            if self.encoding == "onehot" and self.encoder is not None:
+                meta["categories"] = [cat.tolist() for cat in self.encoder.categories_]
+            json.dump(meta, fp, ensure_ascii=False, indent=2)
         self.mlp.save(output_dir, f"{model_name}_stack")
         logger.info("Stack 模型保存完成: %s", output_dir)
 
@@ -92,11 +126,26 @@ class LeafStackModel:
             meta = json.load(fp)
         self.feature_names = meta.get("feature_names")
         self.alpha = meta.get("alpha", self.alpha)
-        self.encoder.categories_ = [np.array(cat) for cat in meta["categories"]]
-        self.encoder.n_features_in_ = len(self.encoder.categories_)
-        # sklearn OneHotEncoder 在推理阶段需要补回 feature_names_in_ 等属性
-        self.encoder.feature_names_in_ = np.array([f"tree_{i}" for i in range(self.encoder.n_features_in_)])
-        self.encoder.drop_idx_ = None
-        self.encoder.sparse_output_ = False
+        self.encoding = meta.get("encoding", self.encoding)
+        self.hash_dim = meta.get("hash_dim", self.hash_dim)
+        if self.encoding == "onehot":
+            self.encoder = OneHotEncoder(handle_unknown="ignore", sparse_output=False, dtype=np.float32)
+            categories = meta.get("categories")
+            if categories is None:
+                raise ValueError("缺少 OneHot categories")
+            self.encoder.categories_ = [np.array(cat) for cat in categories]
+            self.encoder.n_features_in_ = len(self.encoder.categories_)
+            # sklearn OneHotEncoder 在推理阶段需要补回 feature_names_in_ 等属性
+            self.encoder.feature_names_in_ = np.array([f"tree_{i}" for i in range(self.encoder.n_features_in_)])
+            self.encoder.drop_idx_ = None
+            self.encoder.sparse_output_ = False
+            self.hasher = None
+        else:
+            self.encoder = None
+            self.hasher = FeatureHasher(
+                n_features=self.hash_dim,
+                input_type="dict",
+                dtype=np.float32,
+            )
         self.mlp.load(output_dir, f"{model_name}_stack")
 
diff --git a/project/predictor/predictor.py b/project/predictor/predictor.py
index 1a1a1f1..1c47e9f 100644
--- a/project/predictor/predictor.py
+++ b/project/predictor/predictor.py
@@ -10,8 +10,7 @@ from typing import Dict, Tuple
 
 import pandas as pd
 
-from models.lightgbm_model import LightGBMModelWrapper
-from models.mlp_model import MLPRegressor
+from models.ensemble_manager import EnsembleModelManager
 from models.stack_model import LeafStackModel
 from predictor.weight_dynamic import RankICDynamicWeighter
 from utils import load_yaml_config
@@ -26,8 +25,7 @@ class PredictorEngine:
         cfg = load_yaml_config(pipeline_config)
         self.cfg = cfg
         self.paths = cfg["paths"]
-        self.lgb = LightGBMModelWrapper(cfg["lightgbm_config"])
-        self.mlp = MLPRegressor(cfg["mlp_config"])
+        self.ensemble = EnsembleModelManager(cfg, cfg.get("ensemble"))
         self.stack = LeafStackModel(cfg["stack_config"])
         ic_cfg = cfg.get("ic_logging", {})
         self.weighter = RankICDynamicWeighter(
@@ -41,8 +39,7 @@ class PredictorEngine:
     def load_models(self, tag: str):
         model_dir = self.paths["model_dir"]
         logger.info("加载模型，标识: %s", tag)
-        self.lgb.load(model_dir, tag)
-        self.mlp.load(model_dir, tag)
+        self.ensemble.load(model_dir, tag)
         self.stack.load(model_dir, tag)
 
     def predict(
@@ -51,15 +48,17 @@ class PredictorEngine:
         ic_histories: Dict[str, pd.Series],
     ) -> Tuple[pd.Series, Dict[str, pd.Series], Dict[str, float]]:
         """返回融合预测、各模型预测以及权重。"""
-        lgb_pred, leaf = self.lgb.predict(features)
-        mlp_pred = self.mlp.predict(features)
-        residual_pred = self.stack.predict_residual(leaf, features.index)
+        blend_pred, base_preds, aux = self.ensemble.predict(features)
+        lgb_pred = base_preds.get("lgb")
+        lgb_leaf = aux.get("lgb")
+        if lgb_pred is None or lgb_leaf is None:
+            raise RuntimeError("需要 LightGBM 预测以驱动 Stack 模型，请检查 ensemble 配置")
+        residual_pred = self.stack.predict_residual(lgb_leaf, features.index)
         stack_pred = self.stack.fuse(lgb_pred, residual_pred)
-        preds = {
-            "lgb": lgb_pred,
-            "mlp": mlp_pred,
-            "stack": stack_pred,
-        }
+        preds = dict(base_preds)
+        preds["stack"] = stack_pred
+        if blend_pred is not None:
+            preds["qlib_ensemble"] = blend_pred
         # 根据历史 IC 计算动态权重，兼顾稳定性
         weights = self.weighter.get_weights(ic_histories)
         final_pred = self.weighter.blend(preds, weights)
diff --git a/project/run_predict.py b/project/run_predict.py
index 0ad6b41..bca74a9 100644
--- a/project/run_predict.py
+++ b/project/run_predict.py
@@ -46,13 +46,17 @@ def _load_ic_histories(log_path: str) -> Dict[str, pd.Series]:
     if not os.path.exists(log_path):
         today = pd.Timestamp.today()
         base = pd.Series([0.1], index=[today])
-        return {"lgb": base, "mlp": base, "stack": base}
+        return {"lgb": base, "mlp": base, "stack": base, "qlib_ensemble": base}
     df = pd.read_csv(log_path, parse_dates=["valid_end"])
     histories = {
         "lgb": pd.Series(df["ic_lgb"].values, index=df["valid_end"]),
         "mlp": pd.Series(df["ic_mlp"].values, index=df["valid_end"]),
         "stack": pd.Series(df["ic_stack"].values, index=df["valid_end"]),
     }
+    if "ic_qlib_ensemble" in df.columns:
+        histories["qlib_ensemble"] = pd.Series(df["ic_qlib_ensemble"].values, index=df["valid_end"])
+    else:
+        histories["qlib_ensemble"] = histories["lgb"]
     return histories
 
 
diff --git a/project/trainer/__pycache__/trainer.cpython-311.pyc b/project/trainer/__pycache__/trainer.cpython-311.pyc
index 506b197..095cab1 100644
Binary files a/project/trainer/__pycache__/trainer.cpython-311.pyc and b/project/trainer/__pycache__/trainer.cpython-311.pyc differ
diff --git a/project/trainer/trainer.py b/project/trainer/trainer.py
index 9d8211e..2d0c5e9 100644
--- a/project/trainer/trainer.py
+++ b/project/trainer/trainer.py
@@ -12,8 +12,7 @@ from typing import Dict, Iterable, List, Tuple
 import pandas as pd
 
 from feature.qlib_feature_pipeline import QlibFeaturePipeline
-from models.lightgbm_model import LightGBMModelWrapper
-from models.mlp_model import MLPRegressor
+from models.ensemble_manager import EnsembleModelManager
 from models.stack_model import LeafStackModel
 from utils import load_yaml_config
 
@@ -43,8 +42,7 @@ class RollingTrainer:
         self.paths = self.cfg["paths"]
         self.data_cfg_path = self.cfg["data_config"]
         self.pipeline = QlibFeaturePipeline(self.data_cfg_path)
-        self.lgb = LightGBMModelWrapper(self.cfg["lightgbm_config"])
-        self.mlp = MLPRegressor(self.cfg["mlp_config"])
+        self.ensemble = EnsembleModelManager(self.cfg, self.cfg.get("ensemble"))
         self.stack = LeafStackModel(self.cfg["stack_config"])
 
     def _generate_windows(self) -> Iterable[Window]:
@@ -104,40 +102,55 @@ class RollingTrainer:
                 valid_feat = None
                 valid_lbl = None
 
-            # 逐个训练子模型
-            self.lgb.fit(train_feat, train_lbl, valid_feat, valid_lbl)
-            self.mlp.fit(train_feat, train_lbl, valid_feat, valid_lbl)
+            # 统一训练多模型
+            self.ensemble.fit(train_feat, train_lbl, valid_feat, valid_lbl)
 
-            train_pred, train_leaf = self.lgb.predict(train_feat)
-            valid_pred = valid_leaf = None
+            _, train_preds, train_aux = self.ensemble.predict(train_feat)
+            lgb_train_pred = train_preds.get("lgb")
+            lgb_train_leaf = train_aux.get("lgb")
+            if lgb_train_pred is None or lgb_train_leaf is None:
+                raise RuntimeError("LeafStackModel 需要 LightGBM 输出，请在 ensemble.models 中包含 `lgb`")
+            valid_blend = valid_preds = valid_aux = None
             if has_valid:
-                valid_pred, valid_leaf = self.lgb.predict(valid_feat)
+                valid_blend, valid_preds, valid_aux = self.ensemble.predict(valid_feat)
+
+            valid_pred = valid_leaf = None
+            if valid_preds is not None:
+                valid_pred = valid_preds.get("lgb")
+            if valid_aux is not None:
+                valid_leaf = valid_aux.get("lgb")
+
             # residual = label - lgb，用于二级学习
-            train_residual = train_lbl - train_pred
-            valid_residual = None if not has_valid else valid_lbl - valid_pred
+            train_leaf = lgb_train_leaf
+            train_residual = train_lbl - lgb_train_pred
+            valid_residual = None if (not has_valid or valid_pred is None) else valid_lbl - valid_pred
             self.stack.fit(train_leaf, train_residual, valid_leaf, valid_residual)
 
             # 计算验证集 IC
             if has_valid:
-                mlp_valid_pred = self.mlp.predict(valid_feat)
-                stack_residual = self.stack.predict_residual(valid_leaf, valid_feat.index)
-                stack_valid_pred = self.stack.fuse(valid_pred, stack_residual)
+                mlp_valid_pred = valid_preds.get("mlp") if valid_preds is not None else None
+                stack_residual = self.stack.predict_residual(valid_leaf, valid_feat.index) if valid_leaf is not None else None
+                stack_valid_pred = (
+                    self.stack.fuse(valid_pred, stack_residual)
+                    if (valid_pred is not None and stack_residual is not None)
+                    else None
+                )
                 metric = {
                     "window": idx,
                     "train_start": window.train_start,
                     "train_end": window.train_end,
                     "valid_start": window.valid_start,
                     "valid_end": window.valid_end,
-                    "ic_lgb": _rank_ic(valid_pred, valid_lbl),
-                    "ic_mlp": _rank_ic(mlp_valid_pred, valid_lbl),
-                    "ic_stack": _rank_ic(stack_valid_pred, valid_lbl),
+                    "ic_lgb": _rank_ic(valid_pred, valid_lbl) if valid_pred is not None else float("nan"),
+                    "ic_mlp": _rank_ic(mlp_valid_pred, valid_lbl) if mlp_valid_pred is not None else float("nan"),
+                    "ic_stack": _rank_ic(stack_valid_pred, valid_lbl) if stack_valid_pred is not None else float("nan"),
+                    "ic_qlib_ensemble": _rank_ic(valid_blend, valid_lbl) if valid_blend is not None else float("nan"),
                 }
                 metrics.append(metric)
 
             # 以验证区间结束日作为模型文件名，方便按日期加载
             tag = window.valid_end.replace("-", "")
-            self.lgb.save(self.paths["model_dir"], tag)
-            self.mlp.save(self.paths["model_dir"], tag)
+            self.ensemble.save(self.paths["model_dir"], tag)
             self.stack.save(self.paths["model_dir"], tag)
 
         if metrics:
